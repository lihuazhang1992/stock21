from git import Repo
import os, shutil, streamlit as st
import pathlib
import pandas as pd
import sqlite3
import threading
from datetime import datetime

# ============== è‡ªåŠ¨å¤‡ä»½ GitHub ==============
DB_FILE = pathlib.Path(__file__).with_name("stock_data_v12.db")
try:                       
    from dotenv import load_dotenv
    load_dotenv()
    TOKEN    = os.getenv("GITHUB_TOKEN")
    REPO_URL = os.getenv("REPO_URL")
except Exception:
    TOKEN    = st.secrets.get("GITHUB_TOKEN", "")
    REPO_URL = st.secrets.get("REPO_URL", "")

def sync_db_to_github():
    """å½»åº•ä¿®å¤ exit code(128) çš„å¤‡ä»½é€»è¾‘"""
    if not (TOKEN and REPO_URL):
        return
    
    try:
        base_dir = pathlib.Path(__file__).parent
        repo_dir = base_dir / ".git_repo"
        db_name = DB_FILE.name
        auth_url = REPO_URL.replace("https://", f"https://x-access-token:{TOKEN}@")

        if repo_dir.exists():
            shutil.rmtree(repo_dir)

        repo = Repo.clone_from(auth_url, repo_dir, depth=1)

        with repo.config_writer() as cw:
            cw.set_value("user", "name", "Streamlit_Bot")
            cw.set_value("user", "email", "bot@example.com")

        shutil.copy2(base_dir / db_name, repo_dir / db_name)

        if repo.is_dirty(untracked_files=True):
            repo.git.add(all=True)
            repo.index.commit(f"Auto-sync {datetime.now().strftime('%m%d-%H%M')}")
            origin = repo.remote(name='origin')
            origin.push(force=True)
            
            if not os.environ.get("STREAMLIT_CLOUD"):
                st.toast("âœ… GitHub åŒæ­¥æˆåŠŸ", icon="ğŸ“¤")
        else:
            print("æ•°æ®æ— å˜åŠ¨ï¼Œæ— éœ€åŒæ­¥")

    except Exception as e:
        print(f"GitHubå¤‡ä»½ä¸¥é‡é”™è¯¯: {e}")
        if not os.environ.get("STREAMLIT_CLOUD"):
            st.toast(f"âš ï¸ å¤‡ä»½å¤±è´¥: {e}", icon="âš ï¸")

# ==========================================

# --- 1. åŸºç¡€é…ç½®ä¸æ•°æ®åº“è¿æ¥ ---
st.set_page_config(page_title="è‚¡ç¥¨ç®¡ç†ç³»ç»Ÿ v22.1", layout="wide")

def get_connection():
    return sqlite3.connect(pathlib.Path(__file__).with_name("stock_data_v12.db"), check_same_thread=False)

# === å¯åŠ¨æ—¶ï¼šå¦‚æœæœ¬åœ°æ²¡æœ‰æ•°æ®åº“ï¼Œä» GitHub ä¸‹è½½ ===
if not DB_FILE.exists():
    try:
        repo_dir = pathlib.Path(__file__).with_name(".git_repo")
        if repo_dir.exists():
            shutil.rmtree(repo_dir)
        auth_url = REPO_URL.replace("https://", f"https://x-access-token:{TOKEN}@")
        Repo.clone_from(auth_url, repo_dir, depth=1)
        remote_db = repo_dir / DB_FILE.name
        if remote_db.exists():
            shutil.copy2(remote_db, DB_FILE)
            st.toast("âœ… å·²ä» GitHub åŠ è½½æ•°æ®åº“", icon="ğŸ“¥")
        else:
            st.toast("ğŸ†• GitHub æ— æ•°æ®åº“ï¼Œå°†åˆ›å»ºæ–°åº“", icon="âœ¨")
    except Exception as e:
        st.error(f"âŒ æ— æ³•ä» GitHub åŠ è½½æ•°æ®åº“: {e}")

conn = get_connection()
c = conn.cursor()

# --- æ•°æ®åº“è¡¨ç»“æ„è‡ªåŠ¨å‡çº§ï¼ˆä¿®å¤ï¼šå…¨éƒ¨ä½¿ç”¨ä¸‰å¼•å·ï¼‰---
c.execute('''
    CREATE TABLE IF NOT EXISTS trades (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        date TEXT,
        code TEXT,
        action TEXT,
        price REAL,
        quantity INTEGER,
        note TEXT
    )
''')
c.execute('''
    CREATE TABLE IF NOT EXISTS prices (
        code TEXT PRIMARY KEY,
        current_price REAL,
        manual_cost REAL
    )
''')
c.execute('''
    CREATE TABLE IF NOT EXISTS signals (
        code TEXT PRIMARY KEY,
        high_point REAL,
        low_point REAL,
        up_threshold REAL,
        down_threshold REAL,
        high_date TEXT,
        low_date TEXT
    )
''')
c.execute('''
    CREATE TABLE IF NOT EXISTS journal (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        date TEXT,
        stock_name TEXT,
        content TEXT
    )
''')
c.execute('''
    CREATE TABLE IF NOT EXISTS price_targets (
        code TEXT PRIMARY KEY,
        base_price REAL DEFAULT 0.0,
        prior_high REAL DEFAULT 0.0,
        prior_low REAL DEFAULT 0.0,
        break_low REAL DEFAULT 0.0,
        break_high REAL DEFAULT 0.0,
        trend TEXT DEFAULT '',
        last_updated TEXT,
        rebound_rate REAL DEFAULT 0.382,
        fallback_rate REAL DEFAULT 0.618
    )
''')

# åŠ¨æ€å¢åŠ ç¼ºå¤±åˆ—ï¼ˆå…¼å®¹æ—§æ•°æ®åº“ï¼‰
try:
    c.execute("ALTER TABLE prices ADD COLUMN manual_cost REAL DEFAULT 0.0")
except sqlite3.OperationalError:
    pass
try:
    c.execute("ALTER TABLE trades ADD COLUMN note TEXT")
except sqlite3.OperationalError:
    pass

# ä¸ºä»·æ ¼ç›®æ ‡è¡¨æ·»åŠ æ–°åˆ—
def ensure_price_target_columns():
    columns = [
        "prior_high REAL DEFAULT 0.0",
        "prior_low REAL DEFAULT 0.0", 
        "break_low REAL DEFAULT 0.0",
        "break_high REAL DEFAULT 0.0",
        "trend TEXT DEFAULT ''",
        "rebound_rate REAL DEFAULT 0.382",
        "fallback_rate REAL DEFAULT 0.618"
    ]
    for col_def in columns:
        col_name = col_def.split()[0]
        try:
            c.execute(f"ALTER TABLE price_targets ADD COLUMN {col_def}")
        except sqlite3.OperationalError:
            pass
    conn.commit()

ensure_price_target_columns()
conn.commit()

thread = threading.Thread(target=sync_db_to_github, daemon=True)
thread.start()

def get_dynamic_stock_list():
    try:
        t_stocks = pd.read_sql("SELECT DISTINCT code FROM trades", conn)['code'].tolist()
        return sorted(list(set(["æ±‡ä¸°æ§è‚¡", "ä¸­èŠ¯å›½é™…", "æ¯”äºšè¿ª"] + [s for s in t_stocks if s])))
    except:
        return ["æ±‡ä¸°æ§è‚¡", "ä¸­èŠ¯å›½é™…", "æ¯”äºšè¿ª"]

# æ³¨å…¥ CSS æ ·å¼
st.markdown("""
    <style>
    .custom-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 15px; border-radius: 8px; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    .custom-table thead tr { background
