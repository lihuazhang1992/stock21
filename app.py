import pathlib
import streamlit as st
import pandas as pd
import sqlite3
from datetime import datetime
from github import Github, GithubException

# --- 1. åŸºç¡€é…ç½®ä¸æ•°æ®åº“è¿æ¥ ---
st.set_page_config(page_title="è‚¡ç¥¨ç®¡ç†ç³»ç»Ÿ v22.1", layout="wide")

def get_connection():
    return sqlite3.connect(pathlib.Path(__file__).with_name("stock_data_v12.db"), check_same_thread=False)

conn = get_connection()
c = conn.cursor()

# --- æ•°æ®åº“è¡¨ç»“æ„è‡ªåŠ¨å‡çº§ï¼ˆä¿®å¤ï¼šå…¨éƒ¨ä½¿ç”¨ä¸‰å¼•å·ï¼‰---
c.execute('''
    CREATE TABLE IF NOT EXISTS trades (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        date TEXT,
        code TEXT,
        action TEXT,
        price REAL,
        quantity INTEGER,
        note TEXT
    )
''')
c.execute('''
    CREATE TABLE IF NOT EXISTS prices (
        code TEXT PRIMARY KEY,
        current_price REAL,
        manual_cost REAL
    )
''')
c.execute('''
    CREATE TABLE IF NOT EXISTS signals (
        code TEXT PRIMARY KEY,
        high_point REAL,
        low_point REAL,
        up_threshold REAL,
        down_threshold REAL,
        high_date TEXT,
        low_date TEXT
    )
''')
c.execute('''
    CREATE TABLE IF NOT EXISTS journal (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        date TEXT,
        stock_name TEXT,
        content TEXT
    )
''')
c.execute('''
    CREATE TABLE IF NOT EXISTS price_targets (
        code TEXT PRIMARY KEY,
        base_price REAL DEFAULT 0.0,
        buy_target REAL DEFAULT 0.0,
        sell_target REAL DEFAULT 0.0,
        last_updated TEXT
    )
''')
# åŠ¨æ€å¢åŠ ç¼ºå¤±åˆ—ï¼ˆå…¼å®¹æ—§æ•°æ®åº“ï¼‰
try:
    c.execute("ALTER TABLE prices ADD COLUMN manual_cost REAL DEFAULT 0.0")
except sqlite3.OperationalError:
    pass
try:
    c.execute("ALTER TABLE trades ADD COLUMN note TEXT")
except sqlite3.OperationalError:
    pass
conn.commit()

def get_dynamic_stock_list():
    try:
        t_stocks = pd.read_sql("SELECT DISTINCT code FROM trades", conn)['code'].tolist()
        return sorted(list(set(["æ±‡ä¸°æ§è‚¡", "ä¸­èŠ¯å›½é™…", "æ¯”äºšè¿ª"] + [s for s in t_stocks if s])))
    except:
        return ["æ±‡ä¸°æ§è‚¡", "ä¸­èŠ¯å›½é™…", "æ¯”äºšè¿ª"]

# æ³¨å…¥ CSS æ ·å¼
st.markdown("""
    <style>
    .custom-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 15px; border-radius: 8px; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    .custom-table thead tr { background-color: #009879; color: #ffffff; text-align: center; font-weight: bold; }
    .custom-table th, .custom-table td { padding: 12px 15px; text-align: center; border-bottom: 1px solid #dddddd; }
    .custom-table tbody tr:nth-of-type(even) { background-color: #f8f8f8; }
    .profit-red { color: #d32f2f; font-weight: bold; }
    .loss-green { color: #388e3c; font-weight: bold; }
    </style>
""", unsafe_allow_html=True)

# åŒæ­¥å‡½æ•°
def sync_db_to_github():
    db_filename = "stock_data_v12.db"
    local_path = pathlib.Path(__file__).with_name(db_filename)
    if not local_path.exists():
        return

    try:
        token = st.secrets["GITHUB_TOKEN"]
        owner = st.secrets["REPO_OWNER"]
        repo_name = st.secrets["REPO_NAME"]

        g = Github(token)
        repo = g.get_repo(f"{owner}/{repo_name}")

        with open(local_path, "rb") as f:
            content = f.read()

        commit_msg = f"Auto-sync stock_data_v12.db - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"

        try:
            file = repo.get_contents(db_filename)
            repo.update_file(db_filename, commit_msg, content, file.sha, branch="main")
        except GithubException as e:
            if e.status == 404:
                repo.create_file(db_filename, commit_msg, content, branch="main")
            else:
                raise
    except Exception:
        pass  # é™é»˜å¤„ç†

# --- 2. ä¾§è¾¹æ å¯¼èˆª ---
menu = ["ğŸ“Š å®æ—¶æŒä»“", "ğŸ’° ç›ˆåˆ©è´¦å•", "ğŸ¯ ä»·æ ¼ç›®æ ‡ç®¡ç†", "ğŸ“ äº¤æ˜“å½•å…¥", "ğŸ”” ä¹°å–ä¿¡å·", "ğŸ“œ å†å²æ˜ç»†", "ğŸ““ å¤ç›˜æ—¥è®°"]
choice = st.sidebar.radio("åŠŸèƒ½å¯¼èˆª", menu)

# --- å®æ—¶æŒä»“ ---
if choice == "ğŸ“Š å®æ—¶æŒä»“":
    st.header("ğŸ“Š æŒä»“ç›ˆäºåˆ†æ")
  
    # åŠ¨æ€æ ¼å¼åŒ–æ•°å­—çš„å·¥å…·å‡½æ•°ï¼šå»é™¤æœ«å°¾æ— æ„ä¹‰çš„0
    def format_number(num):
        if pd.isna(num) or num is None:
            return "0"
        num_str = f"{num}"
        formatted = num_str.rstrip('0').rstrip('.') if '.' in num_str else num_str
        return formatted
  
    # è¯»å–äº¤æ˜“æ•°æ®å¹¶æŒ‰æ—¶é—´åˆå§‹æ’åº
    df_trades = pd.read_sql("SELECT * FROM trades ORDER BY date ASC, id ASC", conn)
  
    if not df_trades.empty:
        stocks = df_trades['code'].unique()
      
        # ç»´æŠ¤ä¸ªè‚¡ç°ä»·/æ‰‹åŠ¨æˆæœ¬
        with st.expander("ğŸ› ï¸ ç»´æŠ¤ç°ä»·ä¸æ‰‹åŠ¨æˆæœ¬", expanded=True):
            raw_prices = c.execute("SELECT code, current_price, manual_cost FROM prices").fetchall()
            config_query = {row[0]: (row[1], row[2]) for row in raw_prices}
          
            for stock in stocks:
                col1, col2 = st.columns(2)
                stored_vals = config_query.get(stock, (0.0, 0.0))
                old_p = float(stored_vals[0]) if stored_vals[0] is not None else 0.0
                old_c = float(stored_vals[1]) if stored_vals[1] is not None else 0.0
              
                new_p = col1.number_input(f"{stock} ç°ä»·", value=old_p, key=f"p_{stock}", step=0.0001)
                new_c = col2.number_input(f"{stock} æ‰‹åŠ¨æˆæœ¬", value=old_c, key=f"c_{stock}", step=0.0001)
              
                if new_p != old_p or new_c != old_c:
                    c.execute("INSERT OR REPLACE INTO prices (code, current_price, manual_cost) VALUES (?, ?, ?)", 
                              (stock, new_p, new_c))
                    conn.commit()
                    sync_db_to_github()
       
        # è¯»å–æœ€æ–°çš„ç°ä»·/æˆæœ¬é…ç½®
        final_raw = c.execute("SELECT code, current_price, manual_cost FROM prices").fetchall()
        latest_config = {row[0]: (row[1], row[2]) for row in final_raw}
      
        summary = []
        all_active_records = []  # å­˜å‚¨æ‰€æœ‰é…å¯¹äº¤æ˜“å¯¹+æœªå¹³ä»“æŒä»“
        
        # æŒ‰ä¸ªè‚¡å¤„ç†äº¤æ˜“å’ŒæŒä»“
        for stock in stocks:
            s_df = df_trades[df_trades['code'] == stock].copy()
            now_p, manual_cost = latest_config.get(stock, (0.0, 0.0))
          
            # è®¡ç®—å‡€æŒä»“ï¼ˆä¹°å…¥æ€»é‡-å–å‡ºæ€»é‡ï¼‰
            net_buy = s_df[s_df['action'] == 'ä¹°å…¥']['quantity'].sum()
            net_sell = s_df[s_df['action'] == 'å–å‡º']['quantity'].sum()
            net_q = net_buy - net_sell
          
            # è®¡ç®—è´¦æˆ·å±‚é¢çš„ç›ˆäºæ¯”ä¾‹
            if net_q != 0:
                if manual_cost > 0:
                    if net_q > 0:
                        p_rate = ((now_p - manual_cost) / manual_cost) * 100  # æ­£å‘æŒä»“ç›ˆäº
                    else:
                        p_rate = ((manual_cost - now_p) / manual_cost) * 100  # å–ç©ºæŒä»“ç›ˆäº
                else:
                    p_rate = 0.0
                summary.append([
                    stock, net_q, format_number(manual_cost),
                    format_number(now_p), f"{p_rate:.2f}%", p_rate
                ])
           
            # ------------------- æ ¸å¿ƒé€»è¾‘ï¼šé€ç¬”æ—¶é—´æµå¤„ç†äº¤æ˜“ï¼ˆæ— æ—¶é—´ç©¿è¶Šï¼‰ -------------------
            buy_positions = []  # åŠ¨æ€ç»´æŠ¤çš„æ­£å‘æŒä»“æ± ï¼ˆä»…å­˜æœªå¹³ä»“ä¹°å…¥å•ï¼‰
            sell_positions = []  # åŠ¨æ€ç»´æŠ¤çš„å–ç©ºæŒä»“æ± ï¼ˆä»…å­˜æœªå¹³ä»“å–å‡ºå•ï¼‰
            paired_trades = []   # å­˜å‚¨å·²é…å¯¹çš„äº¤æ˜“å¯¹

            # ä¸¥æ ¼æŒ‰ã€äº¤æ˜“æ—¥æœŸ+IDã€‘å‡åºå¤„ç†æ¯ä¸€ç¬”äº¤æ˜“ï¼Œä¿è¯æ—¶é—´æµæ­£ç¡®
            for _, trade in s_df.sort_values(['date', 'id']).iterrows():
                trade_date = trade['date']
                action = trade['action']
                price = trade['price']
                qty = trade['quantity']
                remaining = qty  # åˆå§‹åŒ–å‰©ä½™æœªå¤„ç†æ•°é‡

                if action == 'ä¹°å…¥':
                    # æ­¥éª¤1ï¼šå…ˆå›è¡¥å–ç©ºæŒä»“ï¼ˆé«˜ä»·å–ç©ºå•ä¼˜å…ˆå›è¡¥ï¼Œé”å®šå–ç©ºç›ˆåˆ©ï¼‰
                    if sell_positions and remaining > 0:
                        # å–ç©ºå•æŒ‰ä»·æ ¼ä»é«˜åˆ°ä½æ’åºï¼Œé«˜ä»·ä¼˜å…ˆå›è¡¥
                        for sp in sorted(sell_positions, key=lambda x: -x['price']):
                            if remaining <= 0:
                                break
                            if sp['qty'] <= 0:
                                continue
                            # è®¡ç®—å›è¡¥æ•°é‡ï¼ˆå–å‰©ä½™ä¹°å…¥é‡å’Œå–ç©ºå•é‡çš„æœ€å°å€¼ï¼‰
                            cover_qty = min(sp['qty'], remaining)
                            # è®¡ç®—å–ç©ºå›è¡¥çš„ç›ˆäºæ¯”ä¾‹
                            gain = ((sp['price'] - price) / sp['price'] * 100) if sp['price'] > 0 else 0.0
                            # è®°å½•é…å¯¹äº¤æ˜“å¯¹
                            paired_trades.append({
                                "date": f"{sp['date']} â†’ {trade_date}",
                                "code": stock,
                                "type": "âœ… å·²é…å¯¹äº¤æ˜“å¯¹ï¼ˆä¹°å…¥å›è¡¥å–ç©ºï¼‰",
                                "price": f"{format_number(sp['price'])} â†’ {format_number(price)}",
                                "qty": cover_qty,
                                "gain_str": f"{gain:.2f}%",
                                "gain_val": gain
                            })
                            sp['qty'] -= cover_qty
                            remaining -= cover_qty
                        sell_positions = [sp for sp in sell_positions if sp['qty'] > 0]

                    # æ­¥éª¤2ï¼šå‰©ä½™ä¹°å…¥é‡åŠ å…¥æ­£å‘æŒä»“æ± ï¼ˆä½ä»·ä¼˜å…ˆï¼Œæ–¹ä¾¿åç»­å¹³ä»“æ—¶ä½ä¹°é«˜å–æœ€å¤§åŒ–ç›ˆåˆ©ï¼‰
                    if remaining > 0:
                        buy_positions.append({'date': trade_date, 'price': price, 'qty': remaining})

                elif action == 'å–å‡º':
                    # æ­¥éª¤1ï¼šå…ˆå¹³æ‰æ­£å‘æŒä»“ï¼ˆä½ä»·ä¹°å…¥å•ä¼˜å…ˆå¹³ä»“ï¼Œé”å®šä½ä¹°é«˜å–ç›ˆåˆ©ï¼‰
                    if buy_positions and remaining > 0:
                        # æ­£å‘æŒä»“æŒ‰ä»·æ ¼ä»ä½åˆ°é«˜æ’åºï¼Œä½ä»·ä¼˜å…ˆå¹³ä»“
                        for bp in sorted(buy_positions, key=lambda x: x['price']):
                            if remaining <= 0:
                                break
                            if bp['qty'] <= 0:
                                continue
                            # è®¡ç®—å¹³ä»“æ•°é‡
                            close_qty = min(bp['qty'], remaining)
                            # è®¡ç®—å¹³ä»“ç›ˆäºæ¯”ä¾‹
                            gain = ((price - bp['price']) / bp['price'] * 100) if bp['price'] > 0 else 0.0
                            # è®°å½•é…å¯¹äº¤æ˜“å¯¹
                            paired_trades.append({
                                "date": f"{bp['date']} â†’ {trade_date}",
                                "code": stock,
                                "type": "âœ… å·²é…å¯¹äº¤æ˜“å¯¹ï¼ˆå–å‡ºå¹³æ‰ä¹°å…¥ï¼‰",
                                "price": f"{format_number(bp['price'])} â†’ {format_number(price)}",
                                "qty": close_qty,
                                "gain_str": f"{gain:.2f}%",
                                "gain_val": gain
                            })
                            bp['qty'] -= close_qty
                            remaining -= close_qty
                        buy_positions = [bp for bp in buy_positions if bp['qty'] > 0]

                    # æ­¥éª¤2ï¼šå‰©ä½™å–å‡ºé‡åŠ å…¥å–ç©ºæŒä»“æ± 
                    if remaining > 0:
                        sell_positions.append({'date': trade_date, 'price': price, 'qty': remaining})

            # æœªå¹³ä»“è®°å½•
            for bp in buy_positions:
                if bp['qty'] > 0:
                    float_gain = ((now_p - bp['price']) / bp['price'] * 100) if bp['price'] > 0 else 0.0
                    all_active_records.append({
                        "date": bp['date'],
                        "code": stock,
                        "type": "ä¹°å…¥æŒæœ‰",
                        "price": format_number(bp['price']),
                        "qty": bp['qty'],
                        "gain_str": f"{float_gain:.2f}%",
                        "gain_val": float_gain
                    })

            for sp in sell_positions:
                if sp['qty'] > 0:
                    float_gain = ((sp['price'] - now_p) / sp['price'] * 100) if sp['price'] > 0 else 0.0
                    all_active_records.append({
                        "date": sp['date'],
                        "code": stock,
                        "type": "å–ç©ºæŒæœ‰",
                        "price": format_number(sp['price']),
                        "qty": sp['qty'],
                        "gain_str": f"{float_gain:.2f}%",
                        "gain_val": float_gain
                    })

        # æ˜¾ç¤ºæ€»ç»“ï¼ˆåŸæ ·ä¿ç•™ä½ çš„è¡¨æ ¼é€»è¾‘ï¼Œè¿™é‡Œå‡è®¾ä½ æœ‰åç»­çš„æ˜¾ç¤ºä»£ç ï¼‰

    else:
        st.info("å½“å‰æ²¡æœ‰äº¤æ˜“è®°å½•")

# --- å…¶ä»–é¡µé¢ï¼ˆäº¤æ˜“å½•å…¥ã€å†å²æ˜ç»†ã€å¤ç›˜æ—¥è®°ç­‰ï¼‰ä¿æŒåŸæ ·ï¼Œåªåœ¨ commit å¤„åŠ åŒæ­¥
# ï¼ˆç”±äºä½ çš„åŸå§‹æ–‡æ¡£ä¸­è¿™äº›éƒ¨åˆ†å®Œæ•´ï¼Œæˆ‘è¿™é‡Œåªå±•ç¤ºå…³é”®ä¿®æ”¹ç‚¹ï¼Œå®é™…æ›¿æ¢æ—¶è¯·ä¿æŒåŸä»£ç ç»“æ„ï¼‰

# ç¤ºä¾‹ï¼šåœ¨äº¤æ˜“å½•å…¥çš„ä¿å­˜å¤„
# if submitted:
#     ...
#     conn.commit()
#     sync_db_to_github()

# ç¤ºä¾‹ï¼šåœ¨å†å²æ˜ç»†ç¼–è¾‘ä¿å­˜å¤„
# if st.button("ğŸ’¾ æäº¤æ‰€æœ‰ä¿®æ”¹", type="primary"):
#     ...
#     conn.commit()
#     sync_db_to_github()

# ç¤ºä¾‹ï¼šåœ¨å¤ç›˜æ—¥è®°ä¿å­˜å’Œåˆ é™¤å¤„
# if st.button("ä¿å­˜æ—¥è®°", type="primary"):
#     ...
#     conn.commit()
#     sync_db_to_github()

# if st.button("ğŸ—‘ï¸", key=f"del_{row['id']}"):
#     if st.session_state.get(f"confirm_{row['id']}", False):
#         ...
#         conn.commit()
#         sync_db_to_github()

# --- ä¸‹è½½æ•°æ®åº“æŒ‰é’® ---
col1, col2, col3 = st.columns([5, 1, 1])
with col3:
    db_path = pathlib.Path(__file__).with_name("stock_data_v12.db")
    if db_path.exists():
        with open(db_path, "rb") as f:
            st.download_button(
                label="ğŸ“¥ ä¸‹è½½æ•°æ®åº“",
                data=f,
                file_name="stock_data_v12.db",
                mime="application/x-sqlite3"
            )
